# Bug Analysis

## Root Cause Analysis

### Investigation Summary

The investigation revealed that when AI verifies WCAG criteria and marks them as `AI_VERIFIED_FAIL`, the system correctly stores the criteria verification record with reasoning and confidence, but **does not create corresponding Issue records** for the failures that AI detected independently (i.e., not detected by axe-core).

The data flow analysis confirms:
1. AI Scan CLI generates `criteriaVerifications` with status `AI_VERIFIED_FAIL`
2. CSV import API calls `storeCriteriaVerifications()` which correctly stores these in the `criteria_verifications` table
3. The `relatedIssueIds` field in AI verifications may contain **fabricated IDs** (UUIDs generated by AI) that don't correspond to actual Issue records
4. **No Issue records are created** for AI-only failures, making them invisible in the Issues tab

### Root Cause

**The import logic stores AI criteria verifications but does NOT create Issue records for AI-detected failures.**

The `storeCriteriaVerifications()` function in `ai-queue.service.ts:663-855` only:
1. Creates/updates `CriteriaVerification` records
2. Updates coverage statistics

It does **NOT**:
- Create new `Issue` records for AI_VERIFIED_FAIL criteria
- Link the AI's reasoning to actionable issue details

### Contributing Factors

1. **AI CLI generates fake issue IDs**: The prompt template asks AI to reference existing issue IDs, but when AI finds issues that axe-core didn't detect, it may generate placeholder UUIDs that don't exist in the database.

2. **Design assumption**: The original design assumed AI would only verify criteria that axe-core had already tested, not discover entirely new issues.

3. **Data model gap**: The `CriteriaVerification` model has `reasoning` but this is not surfaced to users in a way that shows actionable issue details.

## Technical Details

### Affected Code Locations

- **File**: `apps/api/src/modules/ai-campaign/ai-queue.service.ts`
  - **Function**: `storeCriteriaVerifications()`
  - **Lines**: `663-855`
  - **Issue**: Stores criteria verifications but doesn't create Issue records for AI_VERIFIED_FAIL status

- **File**: `apps/api/src/modules/ai-campaign/ai-queue.service.ts`
  - **Function**: `importAiResults()`
  - **Lines**: `982-1163`
  - **Issue**: Orchestrates import but doesn't handle creation of new issues from AI verifications

- **File**: `tools/ai-scan-cli/templates/criteria-verification-prompt.hbs`
  - **Lines**: `122-126`
  - **Issue**: Instructs AI to include `relatedIssueIds` only from existing issues, but AI may reference non-existent IDs

### Data Flow Analysis

```
CSV Import Flow:
+-------------------------+
| CSV with AI results     |
| - ai_criteria_verifica- |
|   tions_json with       |
|   AI_VERIFIED_FAIL      |
+-----------+-------------+
            |
            v
+-------------------------+
| importAiResults()       |
| - parseAndValidateCsv() |
| - validateScanEligibility()
| - updateScanWithAiResults()
| - updateIssuesWithAi()  |<-- Only updates EXISTING issues
| - storeCriteriaVerifications()
+-----------+-------------+
            |
            v
+-------------------------+
| storeCriteriaVerifica-  |
| tions()                 |
| - Stores verification   |
|   with reasoning        |
| - DOES NOT create       |
|   Issue records X       |
+-----------+-------------+
            |
            v
+-------------------------+
| Database State          |
| OK criteria_verifications|
|    - AI_VERIFIED_FAIL   |
|    - reasoning present  |
| X  issues table         |
|    - NO records for AI  |
|      only failures      |
+-------------------------+
```

### Dependencies

- **Prisma models**: `CriteriaVerification`, `Issue`, `ScanResult`
- **AI Scan CLI**: Generates `criteriaVerifications` in CSV export
- **UI components**: Criteria table shows failures, Issues tab shows nothing

## Impact Analysis

### Direct Impact

1. **Users see failures without actionable information**: Criteria Table shows AI_VERIFIED_FAIL but Issues tab is empty
2. **AI analysis partially hidden**: Valuable AI reasoning about failures is not accessible to users
3. **Misleading scan results**: Users may think the scan found no issues when AI actually detected problems

### Indirect Impact

1. **Reduced value of AI enhancement**: Users pay for AI analysis but don't get full visibility into findings
2. **Trust issues**: Discrepancy between Criteria Table and Issues Tab may confuse users
3. **Incomplete remediation**: Users can't fix issues they can't see

### Risk Assessment

- **Severity**: HIGH - Core feature not working as expected
- **Frequency**: Every scan with AI_VERIFIED_FAIL criteria is affected
- **Business impact**: Reduces value proposition of AI-enhanced scans

## Solution Approach

### Fix Strategy

Create Issue records for AI-detected failures during the import process:

1. **When storing AI_VERIFIED_FAIL verifications**, create corresponding Issue records
2. **Use AI reasoning** to populate issue description and help text
3. **Generate synthetic rule IDs** for AI-detected issues (e.g., `ai-wcag-2.4.1`)
4. **Link issues to criteria verifications** via the relation

### Alternative Solutions

**Alternative 1: Show AI reasoning directly in UI**
- Modify Criteria Table to show detailed reasoning inline
- Pros: Simpler implementation, no database changes
- Cons: Doesn't fix the Issues tab, inconsistent UX

**Alternative 2: Virtual issues from criteria verifications**
- Generate "virtual" issue objects at query time from AI_VERIFIED_FAIL verifications
- Pros: No new database records needed
- Cons: Complex query logic, doesn't persist issue-level data

**Alternative 3: Create real Issue records (Recommended)**
- Create actual Issue records for AI-detected failures
- Pros: Consistent data model, full feature parity, proper tracking
- Cons: Requires generating synthetic rule IDs and mappings

### Risks and Trade-offs

1. **Duplicate detection**: Need to ensure we don't create issues that axe-core already found
2. **Impact classification**: AI provides reasoning but not always clear CRITICAL/SERIOUS/etc. impact
3. **Rule ID mapping**: Need synthetic rule IDs that are clearly AI-sourced

## Implementation Plan

### Changes Required

1. **Change 1**: Create helper function to generate Issue from AI verification
   - File: `apps/api/src/modules/ai-campaign/ai-queue.service.ts`
   - Modification: Add `createIssueFromAiVerification()` function that:
     - Creates an Issue record with:
       - `ruleId`: `ai-wcag-{criterionId}` (e.g., `ai-wcag-2.4.1`)
       - `wcagCriteria`: `[criterionId]`
       - `impact`: Default to `SERIOUS` (or map from confidence)
       - `description`: AI reasoning
       - `helpText`: AI reasoning (more detailed)
       - `helpUrl`: Link to WCAG understanding document
       - `htmlSnippet`: `"[AI-detected issue - see description]"`
       - `cssSelector`: `"body"` or `"N/A"`
       - `aiExplanation`: AI reasoning
       - `aiPriority`: Map from confidence

2. **Change 2**: Modify `storeCriteriaVerifications()` to create issues
   - File: `apps/api/src/modules/ai-campaign/ai-queue.service.ts`
   - Modification: After storing AI_VERIFIED_FAIL verification, call `createIssueFromAiVerification()` if no existing related issues

3. **Change 3**: Update issue counts in ScanResult
   - File: `apps/api/src/modules/ai-campaign/ai-queue.service.ts`
   - Modification: Increment `totalIssues` and `seriousCount` (or appropriate impact count) after creating AI issues

4. **Change 4**: Link created issues to criteria verifications
   - File: `apps/api/src/modules/ai-campaign/ai-queue.service.ts`
   - Modification: Use the `CriteriaIssues` relation to connect new Issue records to their CriteriaVerification

### Testing Strategy

1. **Unit tests**: Test `createIssueFromAiVerification()` function
2. **Integration tests**: Test full import flow with AI_VERIFIED_FAIL criteria
3. **E2E tests**: Verify Issues tab shows AI-detected issues
4. **Regression tests**: Ensure existing issue enhancement still works

### Rollback Plan

1. If the fix causes issues, the change can be reverted
2. Existing data: AI-created issues can be identified by `ruleId` pattern `ai-wcag-*`
3. Clean up: Can delete issues matching `ai-wcag-*` pattern if needed
