# Bug Report: AI Scan Failed to Import

## Bug ID
`ai-scan-failed-to-import`

## Summary
AI scan results generated by the ai-scan-cli tool fail to import via the admin API endpoint `/api/v1/admin/ai-queue/import` due to CSV column name and format mismatches.

## Severity
**High** - Blocks the primary workflow of importing AI-processed scan results into the system.

## Status
**FIXED** - Both issues have been addressed.

## Environment
- **Component**: ai-scan-cli (tools/ai-scan-cli)
- **API Endpoint**: POST /api/v1/admin/ai-queue/import
- **Related Files**:
  - `tools/ai-scan-cli/src/result-transformer.ts`
  - `tools/ai-scan-cli/src/csv-writer.ts`
  - `tools/ai-scan-cli/src/csv-parser.ts`
  - `tools/ai-scan-cli/src/types.ts`
  - `tools/ai-scan-cli/src/prompt-generator.ts`
  - `tools/ai-scan-cli/src/mini-batch-processor.ts`
  - `tools/ai-scan-cli/src/result-parser.ts`
  - `tools/ai-scan-cli/templates/issue-enhancement-prompt.hbs`
  - `apps/api/src/modules/ai-campaign/ai-campaign.schema.ts`

## Steps to Reproduce
1. Run ai-scan-cli to process pending scans:
   ```bash
   ./dist/cli.js --input pending-scans.csv --output ./results/
   ```
2. Attempt to import the generated CSV via API:
   ```bash
   POST /api/v1/admin/ai-queue/import
   Content-Type: multipart/form-data
   file: <generated-csv-file>
   ```
3. Observe validation error response

## Expected Behavior
The generated CSV should be accepted by the import API and the AI scan results should be **merged with the existing axe-core scan results**. This means:

1. The import API accepts the CSV file without validation errors
2. AI enhancement fields (`ai_summary`, `ai_remediation_plan`, `ai_issues_json`) are merged into the existing scan record (matched by `scan_id`)
3. The combined scan result shows both:
   - **axe-core results**: Automated accessibility violations detected by axe-core
   - **AI enhancements**: AI-generated summary, remediation plan, and enriched issue analysis
4. The scan appears as a complete, unified result in the admin panel and user-facing reports

## Root Cause

### Issue 1: CSV Column Mismatches (FIXED)
The ai-scan-cli was generating CSV with incorrect column names and missing required fields:

| Generated Column | Expected Column | Status |
|------------------|-----------------|--------|
| `issues_with_ai_json` | `ai_issues_json` | Fixed |
| (missing) | `tokens_used` | Fixed |
| (missing) | `processing_time` | Fixed |
| `ai_summary` (JSON object) | `ai_summary` (plain text) | Fixed |
| `ai_remediation_plan` (JSON object) | `ai_remediation_plan` (plain text) | Fixed |

### Issue 2: AI Issues Format Mismatch (FIXED)
The API expects `ai_issues_json` to contain enhancements for **EXISTING** axe-core issues, not new issues.

**Expected format** (to update existing issues):
```json
[
  {
    "issueId": "existing-axe-core-issue-uuid",
    "aiExplanation": "Plain language explanation...",
    "aiFixSuggestion": "Code fix suggestion...",
    "aiPriority": 9
  }
]
```

### The Intended Flow (Now Implemented)
1. **Export**: Admin exports pending AI scans â†’ CSV includes existing axe-core issues with their UUIDs in `issues_json` column
2. **Process**: CLI reads existing issues and enhances them with AI explanations
3. **Import**: API updates existing Issue records by matching `issueId`

## Fix Applied

### Issue 1 Fix: CSV Column/Format
1. **`src/types.ts`**: Updated `ImportRow` interface to match API schema
2. **`src/result-transformer.ts`**:
   - Added `formatSummary()` to convert JSON summary to plain text
   - Added `formatRemediationPlan()` to convert JSON plan to plain text
   - Added `estimateTokensUsed()` for token estimation
   - Added `getAiIssuesJson()` to output correct format based on mode
   - Updated `transformToImportFormat()` to include all required fields
3. **`src/csv-writer.ts`**: Updated CSV headers and row mapping
4. **`src/mini-batch-processor.ts`**: Added `durationMs` tracking to ScanResult

### Issue 2 Fix: Enhancement Mode
1. **`src/types.ts`**:
   - Added `ExistingIssue` interface for axe-core issue format
   - Added `AiIssueEnhancement` interface for AI enhancement format
   - Updated `PendingScan` to include `existingIssues` and `pageTitle`
   - Updated `ScanResult` to include `aiEnhancements`

2. **`src/csv-parser.ts`**:
   - Added parsing of `issues_json` column from exported CSV
   - Added parsing of `page_title` column
   - Issues are stored as `existingIssues` on `PendingScan`

3. **`templates/issue-enhancement-prompt.hbs`** (NEW):
   - New prompt template for enhancing existing issues
   - Accepts existing issues JSON and outputs `aiEnhancements` array
   - Outputs plain text summary and remediation plan

4. **`src/prompt-generator.ts`**:
   - Added `generateIssueEnhancementPrompt()` function
   - Added `IssueEnhancementContext` interface

5. **`src/result-parser.ts`**:
   - Added `normalizeEnhancement()` for parsing single enhancement
   - Added `normalizeEnhancements()` for parsing enhancement array
   - Updated `normalizeScanResult()` to handle both modes

6. **`src/mini-batch-processor.ts`**:
   - Added `DownloadedSiteWithIssues` interface
   - Updated `processMiniBatch()` to attach existing issues to downloaded sites
   - Updated `analyzeSiteWithRetry()` to:
     - Detect enhancement mode (when `existingIssues` present)
     - Use appropriate prompt template based on mode
     - Log which mode is being used

## How It Works Now

### Discovery Mode (no existing issues)
When the input CSV does NOT have `issues_json`:
1. CLI downloads website
2. Claude analyzes HTML and discovers new issues
3. Output contains full issue details with new UUIDs

### Enhancement Mode (with existing issues)
When the input CSV HAS `issues_json`:
1. CLI downloads website for context
2. Claude enhances EXISTING issues with:
   - `aiExplanation`: Plain language explanation
   - `aiFixSuggestion`: Specific fix recommendation
   - `aiPriority`: Priority score 1-10
3. Output contains only enhancement data with matching `issueId`

## Verification Status
- [x] CLI builds successfully
- [x] CLI generates CSV with correct column names
- [x] `ai_summary` is plain text
- [x] `ai_remediation_plan` is plain text
- [x] `tokens_used` and `processing_time` are included
- [x] Enhancement mode implemented when `issues_json` present in input
- [x] `ai_issues_json` format matches API expectations
- [ ] Import API accepts the generated CSV (needs testing)
- [ ] AI enhancements merge with existing axe-core issues (needs testing)
- [ ] Combined results appear correctly in admin panel (needs testing)

## Testing Required
1. Export pending scans from admin panel (should include `issues_json`)
2. Process with CLI: `./dist/cli.js --input exported-scans.csv --output ./results/`
3. Verify output CSV has correct `ai_issues_json` format
4. Import via API and verify data merges correctly

## Related Issues
- Original spec: `.claude/specs/local-ai-scan-cli/`
- API schema: `apps/api/src/modules/ai-campaign/ai-campaign.schema.ts`

## Reporter
Claude Code Assistant

## Date Created
2026-01-04

## Date Fixed
2026-01-04
