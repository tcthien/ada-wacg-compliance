# Requirements Document: AI Scan Merge Results

## Introduction

This specification defines the requirements for ensuring AI scan results (generated by the ai-scan-cli tool) properly merge with existing axe-core scan results. The goal is to enable users to see a unified scan detail view that combines:

1. **Axe-core results**: Automated accessibility violations (ruleId, impact, description, htmlSnippet, etc.)
2. **AI enhancements**: AI-generated explanations, fix suggestions, and priority scores

Currently, the ai-scan-cli tool generates CSV output with the correct format (`ai_issues_json` with `issueId` references), but end-to-end verification and potential fixes are needed to ensure the complete workflow functions correctly.

## Alignment with Product Vision

This feature directly supports the ADAShield product vision of providing **AI-enhanced accessibility testing**:

- **Value Proposition**: Combines automated axe-core detection (~57% of issues) with AI insights to provide more actionable remediation guidance
- **User Experience**: Unified scan detail view shows both the technical violation and plain-language AI explanation
- **Competitive Advantage**: Differentiates from pure automated tools by adding AI intelligence layer

## Requirements

### Requirement 1: CLI Output Format Compatibility

**User Story:** As an admin, I want the ai-scan-cli to output CSV in the format expected by the import API, so that AI results can be imported without errors.

#### Acceptance Criteria

1. WHEN the CLI processes a scan with existing issues THEN the output CSV SHALL contain columns: `scan_id`, `ai_summary`, `ai_remediation_plan`, `ai_issues_json`, `tokens_used`, `ai_model`, `processing_time`
2. WHEN the CLI generates `ai_issues_json` THEN each enhancement object SHALL contain: `issueId` (matching original issue UUID), `aiExplanation`, `aiFixSuggestion`, `aiPriority`
3. WHEN the CLI generates `ai_summary` THEN the value SHALL be plain text (not JSON object)
4. WHEN the CLI generates `ai_remediation_plan` THEN the value SHALL be plain text (not JSON object)
5. WHEN `tokens_used` is generated THEN it SHALL be a positive integer representing estimated token count
6. WHEN `processing_time` is generated THEN it SHALL be an integer representing seconds (0-3600)

### Requirement 2: Import API Merge Functionality

**User Story:** As an admin, I want the import API to merge AI enhancements into existing scan records, so that both axe-core and AI data coexist in the database.

#### Acceptance Criteria

1. WHEN importing a CSV row THEN the API SHALL validate the scan exists AND has `aiStatus='DOWNLOADED'`
2. WHEN import succeeds THEN the Scan record SHALL be updated with `aiSummary`, `aiRemediationPlan`, `aiTotalTokens`, `aiModel`, `aiProcessingTime`, and `aiStatus='COMPLETED'`
3. WHEN `ai_issues_json` is processed THEN each Issue record matching `issueId` SHALL be updated with `aiExplanation`, `aiFixSuggestion`, `aiPriority`
4. WHEN an Issue update fails THEN the API SHALL continue processing remaining issues AND log the error
5. WHEN all updates complete THEN the original axe-core data (ruleId, impact, description, htmlSnippet, etc.) SHALL remain unchanged

### Requirement 3: Scan Detail Unified View

**User Story:** As a user, I want to see both axe-core and AI data in the scan detail view, so that I can understand violations with AI-enhanced guidance.

#### Acceptance Criteria

1. WHEN viewing scan detail THEN the page SHALL display the AI summary section (if `aiStatus='COMPLETED'`)
2. WHEN viewing scan detail THEN the page SHALL display the AI remediation plan (if available)
3. WHEN viewing an issue THEN the issue card SHALL show both axe-core data (description, helpText, htmlSnippet) AND AI data (aiExplanation, aiFixSuggestion, aiPriority)
4. IF `aiPriority` is set THEN the UI SHALL display a priority badge or indicator (1-10 scale)
5. IF AI data is missing for an issue THEN the UI SHALL gracefully hide AI sections rather than show empty/null values

### Requirement 4: Export API Data Completeness

**User Story:** As an admin, I want the export API to include all necessary issue data, so that the CLI can properly generate AI enhancements.

#### Acceptance Criteria

1. WHEN exporting pending scans THEN the CSV SHALL include column `issues_json` with complete Issue records
2. WHEN serializing issues THEN each issue SHALL include: `id`, `ruleId`, `wcagCriteria`, `impact`, `description`, `helpText`, `helpUrl`, `htmlSnippet`, `cssSelector`
3. WHEN export completes THEN the scan status SHALL be atomically updated to `aiStatus='DOWNLOADED'`

### Requirement 5: Issue ID Preservation

**User Story:** As a developer, I want issue IDs to be preserved through the export-process-import cycle, so that AI enhancements merge with correct issues.

#### Acceptance Criteria

1. WHEN the CLI reads `issues_json` THEN it SHALL extract the `id` field from each issue
2. WHEN the CLI generates enhancements THEN the `issueId` field SHALL exactly match the original issue `id`
3. WHEN the import API processes `ai_issues_json` THEN it SHALL match `issueId` to Issue records by primary key

## Non-Functional Requirements

### Performance

- Import API SHALL process 100 scans within 60 seconds
- CLI SHALL process 10 scans with AI enhancement within 10 minutes
- Scan detail page SHALL load within 2 seconds including AI data

### Security

- Import API SHALL require admin authentication
- CSV files SHALL not be stored server-side after import processing
- AI API keys SHALL not be exposed in CLI logs or output files

### Reliability

- Import SHALL be atomic per scan (all-or-nothing per row)
- Failed imports SHALL not affect other scans in the same batch
- CLI SHALL retry AI API calls up to 3 times on transient failures

### Usability

- Error messages SHALL clearly indicate which scan/issue failed and why
- CLI SHALL provide progress output showing current scan and status
- Admin UI SHALL show import success/failure counts and error details

## Out of Scope

- Creating new issues from AI (AI only enhances existing axe-core issues)
- Modifying axe-core detection logic
- Real-time AI processing during scan (batch workflow only)
- AI summary/remediation plan editing in UI
